name: Frontend Tests

on:
  push:
    branches: [main, develop, staging]
    paths:
      - 'frontend/**'
      - '.github/workflows/test-frontend.yml'
  pull_request:
    branches: [main, develop, staging]
    paths:
      - 'frontend/**'
      - '.github/workflows/test-frontend.yml'
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  test:
    name: Frontend Tests (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        node-version: ['18', '20', '21']
        environment: ['dev', 'staging']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Install testing dependencies
        run: |
          cd frontend
          npm install --save-dev vitest @vitest/ui @vitest/coverage-v8 jsdom @testing-library/react @testing-library/jest-dom @testing-library/user-event

      - name: Set up environment variables
        run: |
          cd frontend
          echo "VITE_API_URL=http://localhost:8000/api" >> .env.test
          echo "VITE_ENVIRONMENT=${{ matrix.environment }}" >> .env.test

      - name: Run unit tests with coverage
        run: |
          cd frontend
          npm run test -- --run --coverage
        env:
          CI: true
          VITE_API_URL: http://localhost:8000/api

      - name: Upload coverage to Codecov
        if: matrix.node-version == '20' && matrix.environment == 'dev'
        uses: codecov/codecov-action@v4
        with:
          file: ./frontend/coverage/coverage-final.json
          flags: frontend
          name: frontend-coverage-${{ matrix.environment }}
          fail_ci_if_error: false

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-test-results-${{ matrix.node-version }}-${{ matrix.environment }}
          path: |
            frontend/coverage/
            frontend/test-results/
          retention-days: 7

  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Run ESLint
        run: |
          cd frontend
          npm run lint -- --max-warnings 0 --format json --output-file eslint-report.json || true

      - name: Run style checks
        run: |
          cd frontend
          npm install --save-dev prettier
          npx prettier --check "src/**/*.{js,jsx,css}" || true

      - name: Run type checks
        run: |
          cd frontend
          npm install --save-dev typescript @types/react @types/react-dom
          npx tsc --noEmit || true

      - name: Upload linting reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-lint-reports
          path: |
            frontend/eslint-report.json
          retention-days: 7

  build:
    name: Build Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Build production bundle
        run: |
          cd frontend
          npm run build

      - name: Check bundle size
        run: |
          cd frontend
          npm install --save-dev bundlesize
          npx bundlesize || true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ github.sha }}
          path: frontend/dist/
          retention-days: 7

      - name: Upload build size report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-report
          path: frontend/.bundlesize-report
          retention-days: 7

  accessibility:
    name: Accessibility Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Install accessibility tools
        run: |
          cd frontend
          npm install --save-dev @axe-core/react jest-axe

      - name: Build application
        run: |
          cd frontend
          npm run build

      - name: Run accessibility tests
        run: |
          cd frontend
          npm run test -- --run --testNamePattern="accessibility" || true

      - name: Upload accessibility report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-a11y-report
          path: frontend/a11y-report.json
          retention-days: 7

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run npm audit
        run: |
          cd frontend
          npm audit --json > npm-audit-report.json || true

      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
          command: test
          working-directory: frontend

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-security-reports
          path: |
            frontend/npm-audit-report.json
          retention-days: 7

  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [test, lint, build]
    if: failure()

    steps:
      - name: Send notification
        run: |
          echo "Frontend tests failed for ${{ github.event_name }} event"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          # Add your notification logic here (Slack, email, etc.)
