name: Unified Test Pipeline

on:
  push:
    branches: [main, develop, staging]
  pull_request:
    branches: [main, develop, staging]
  workflow_dispatch:
    inputs:
      run_e2e:
        description: 'Run E2E tests'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - 'dev'
          - 'staging'
          - 'production'

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'
  POSTGRES_VERSION: '15'
  # Cache settings
  CACHE_VERSION: 'v1'

jobs:
  # ==================== BACKEND TESTS ====================
  backend-unit:
    name: Backend Unit Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:${{ env.POSTGRES_VERSION }}
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      qdrant:
        image: qdrant/qdrant:latest
        ports:
          - 6333:6333
        options: >-
          --health-cmd "curl -f http://localhost:6333/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ env.CACHE_VERSION }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            ${{ env.CACHE_VERSION }}-pip-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'backend/requirements.txt'

      - name: Install dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-asyncio pytest-mock pytest-xdist
          pip install -r requirements.txt

      - name: Set up environment
        run: |
          cd backend
          cat > .env.test << EOF
          DATABASE_URL=postgresql://test_user:test_password@localhost:5432/test_db
          QDRANT_URL=http://localhost:6333
          EVOLUTION_API_KEY=test_key
          EVOLUTION_BASE_URL=https://api.example.com
          SECRET_KEY=test_secret_key
          ENVIRONMENT=test
          EOF

      - name: Initialize database
        run: |
          cd backend
          python -c "from app.database import init_db; init_db()"

      - name: Run unit tests
        run: |
          cd backend
          pytest tests/unit/ \
            --cov=app \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --junitxml=test-results/junit-unit.xml \
            -v \
            -n auto \
            --tb=short
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          QDRANT_URL: http://localhost:6333

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-unit-coverage
          path: |
            backend/coverage.xml
            backend/htmlcov/
            backend/test-results/
          retention-days: 7

  backend-integration:
    name: Backend Integration Tests
    runs-on: ubuntu-latest
    needs: backend-unit

    services:
      postgres:
        image: postgres:${{ env.POSTGRES_VERSION }}
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      qdrant:
        image: qdrant/qdrant:latest
        ports:
          - 6333:6333
        options: >-
          --health-cmd "curl -f http://localhost:6333/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'backend/requirements.txt'

      - name: Install dependencies
        run: |
          cd backend
          pip install pytest pytest-cov pytest-asyncio pytest-mock httpx
          pip install -r requirements.txt

      - name: Set up environment
        run: |
          cd backend
          cat > .env.test << EOF
          DATABASE_URL=postgresql://test_user:test_password@localhost:5432/test_db
          QDRANT_URL=http://localhost:6333
          EVOLUTION_API_KEY=test_key
          EVOLUTION_BASE_URL=https://api.example.com
          SECRET_KEY=test_secret_key
          ENVIRONMENT=test
          EOF

      - name: Initialize database
        run: |
          cd backend
          python -c "from app.database import init_db; init_db()"

      - name: Run integration tests
        run: |
          cd backend
          pytest tests/integration/ \
            --cov=app \
            --cov-report=xml \
            --cov-append \
            --junitxml=test-results/junit-integration.xml \
            -v \
            -n auto \
            --tb=short
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          QDRANT_URL: http://localhost:6333

      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-integration-results
          path: backend/test-results/
          retention-days: 7

  # ==================== FRONTEND TESTS ====================
  frontend-unit:
    name: Frontend Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Install testing dependencies
        run: |
          cd frontend
          npm install --save-dev vitest @vitest/ui @vitest/coverage-v8 jsdom @testing-library/react @testing-library/jest-dom @testing-library/user-event

      - name: Set up environment
        run: |
          cd frontend
          echo "VITE_API_URL=http://localhost:8000/api" > .env.test
          echo "VITE_ENVIRONMENT=test" >> .env.test

      - name: Run unit tests
        run: |
          cd frontend
          npm run test -- --run --coverage
        env:
          CI: true

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-unit-coverage
          path: |
            frontend/coverage/
            frontend/test-results/
          retention-days: 7

  # ==================== E2E TESTS ====================
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.run_e2e != 'false' || github.event_name == 'push'

    strategy:
      fail-fast: false
      matrix:
        shard: [1/4, 2/4, 3/4, 4/4]

    services:
      postgres:
        image: postgres:${{ env.POSTGRES_VERSION }}
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      qdrant:
        image: qdrant/qdrant:latest
        ports:
          - 6333:6333
        options: >-
          --health-cmd "curl -f http://localhost:6333/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium firefox webkit

      - name: Install backend dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Set up environment
        run: |
          # Backend env
          cd backend
          cat > .env.test << EOF
          DATABASE_URL=postgresql://test_user:test_password@localhost:5432/test_db
          QDRANT_URL=http://localhost:6333
          EVOLUTION_API_KEY=test_key
          EVOLUTION_BASE_URL=https://api.example.com
          SECRET_KEY=test_secret_key
          ENVIRONMENT=test
          CORS_ORIGINS=http://localhost:5173
          EOF

          # Frontend env
          cd ../frontend
          cat > .env.test << EOF
          VITE_API_URL=http://localhost:8000/api
          VITE_ENVIRONMENT=test
          EOF

      - name: Initialize database
        run: |
          cd backend
          python -c "from app.database import init_db; init_db()"
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db

      - name: Start services
        run: |
          # Start backend
          cd backend
          uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          echo $! > backend.pid

          # Build and start frontend
          cd ../frontend
          npm run build
          npx vite preview --host 0.0.0.0 --port 5173 &
          echo $! > frontend.pid

          # Wait for services
          timeout 60 bash -c 'until curl -f http://localhost:8000/health; do sleep 2; done'
          timeout 30 bash -c 'until curl -f http://localhost:5173; do sleep 2; done'

      - name: Run E2E tests
        run: |
          npx playwright test \
            --shard=${{ matrix.shard }} \
            --reporter=html,json \
            --reporter-json-output=test-results/results.json
        env:
          BASE_URL: http://localhost:5173
          API_URL: http://localhost:8000/api
          NODE_ENV: test

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results-shard-${{ matrix.shard }}
          path: |
            test-results/
            playwright-report/
          retention-days: 7

      - name: Stop services
        if: always()
        run: |
          if [ -f backend/backend.pid ]; then
            kill $(cat backend/backend.pid) || true
          fi
          if [ -f frontend/frontend.pid ]; then
            kill $(cat frontend/frontend.pid) || true
          fi

  # ==================== CODE QUALITY ====================
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Backend linting
        run: |
          pip install black isort ruff flake8 mypy
          cd backend
          black --check app/ tests/ || true
          isort --check-only app/ tests/ || true
          ruff check app/ tests/ || true
          flake8 app/ tests/ --max-line-length=100 || true
          mypy app/ --ignore-missing-imports || true

      - name: Frontend linting
        run: |
          cd frontend
          npm ci
          npm run lint || true
          npx prettier --check "src/**/*.{js,jsx,css}" || true

      - name: Dockerfile linting
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: backend/Dockerfile
        continue-on-error: true

      - name: YAML linting
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: .github/workflows/
        continue-on-error: true

      - name: Upload quality reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-quality-reports
          path: |
            **/*report*.txt
            **/*report*.json
          retention-days: 7

  # ==================== SECURITY SCANS ====================
  security:
    name: Security Scans
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy'

      - name: Backend security scan
        run: |
          pip install safety bandit
          cd backend
          safety check || true
          bandit -r app/ || true

      - name: Frontend security scan
        run: |
          cd frontend
          npm ci
          npm audit --audit-level=moderate || true

  # ==================== REPORTING ====================
  coverage-report:
    name: Merge Coverage Reports
    runs-on: ubuntu-latest
    needs: [backend-unit, backend-integration, frontend-unit]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download backend coverage
        uses: actions/download-artifact@v4
        with:
          name: backend-unit-coverage
          path: backend/coverage/

      - name: Download frontend coverage
        uses: actions/download-artifact@v4
        with:
          name: frontend-unit-coverage
          path: frontend/coverage/

      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: |
            ./backend/coverage.xml
            ./frontend/coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Generate coverage summary
        run: |
          echo "## Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Backend and frontend coverage reports have been merged." >> $GITHUB_STEP_SUMMARY

  # ==================== NOTIFICATION ====================
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [backend-unit, backend-integration, frontend-unit, e2e, code-quality, security]
    if: failure()

    steps:
      - name: Determine status
        id: status
        run: |
          if [ "${{ needs.backend-unit.result }}" == "failure" ] || \
             [ "${{ needs.backend-integration.result }}" == "failure" ] || \
             [ "${{ needs.frontend-unit.result }}" == "failure" ] || \
             [ "${{ needs.e2e.result }}" == "failure" ] || \
             [ "${{ needs.code-quality.result }}" == "failure" ] || \
             [ "${{ needs.security.result }}" == "failure" ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
          fi

      - name: Send notification
        if: steps.status.outputs.status == 'failed'
        run: |
          echo "‚ùå Pipeline failed for ${{ github.event_name }} event"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          # Add your notification logic here:
          # - Slack webhook
          # - Email notification
          # - Discord webhook
          # - Teams webhook

      - name: Create GitHub issue on failure
        if: github.event_name == 'push' && steps.status.outputs.status == 'failed'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Pipeline failed for ${context.ref}`,
              body: `The test pipeline failed for commit ${context.sha}.

              **Event:** ${context.eventName}
              **Branch:** ${context.ref}
              **Actor:** ${context.actor}

              Please check the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`,
              labels: ['pipeline-failure', 'automated']
            })
