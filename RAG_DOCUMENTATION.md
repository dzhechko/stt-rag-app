# Advanced RAG System - Документация

## Обзор

Система RAG (Retrieval Augmented Generation) использует векторный поиск для нахождения релевантных фрагментов транскриптов и генерации ответов на основе найденной информации.

## Текущие возможности

### 1. Multi-hop Reasoning (DSPy)
- **Статус**: ✅ Реализовано
- Автоматически разбивает сложные вопросы на 2-4 подвопроса
- Выполняет итеративный поиск для каждого подвопроса
- Объединяет и дедуплицирует результаты
- **Настройка**: Включить "Enable Multi-hop Reasoning" в Settings

### 2. Hybrid Search (BM25 + Vector)
- **Статус**: ✅ Реализовано
- Комбинирует векторный (семантический) и BM25 (ключевые слова) поиск
- Веса по умолчанию: 70% векторный, 30% BM25
- Лучшее покрытие как семантических, так и точных совпадений терминов
- **Настройка**: Включить "Enable Hybrid Search" в Settings

### 3. Векторный поиск (Vector Search)
- **Embeddings**: Используется локальная модель `all-MiniLM-L6-v2` (размерность 384)
- **Хранилище**: Qdrant для векторного поиска
- **Метод**: Cosine similarity для поиска похожих фрагментов

### 4. Specialized Reranking
- **Статус**: ✅ Реализовано
- Использует cross-encoder модели для точной оценки релевантности
- Доступные модели:
  - `ms-marco-MiniLM-L-6-v2` (быстрая, легковесная, ~22MB)
  - `bge-reranker-v2-m3` (лучшее качество, медленнее, ~420MB)
- Fallback на LLM-based reranking если модель недоступна
- **Настройка**: Выбрать модель в Settings → Reranker Model

### 5. Генерация ответов
- **Модель по умолчанию**: `GigaChat/GigaChat-2-Max`
- **Температура**: 0.3 (консервативный подход)
- **Контекст**: Используются top-k наиболее релевантных чанков

### 6. Advanced Quality Grading
- **Статус**: ✅ Реализовано
- **Groundedness** (0.0-1.0): Проверка, что факты в ответе подтверждены retrieved chunks
- **Completeness** (0.0-1.0): Оценка полноты ответа относительно вопроса
- **Relevance** (0.0-1.0): Релевантность ответа вопросу
- **Overall Score** (0.0-5.0): Взвешенная оценка (40% groundedness, 30% completeness, 30% relevance)
- **Настройка**: Включить "Enable Advanced Quality Grading" в Settings

## Настройки RAG

### Параметры запроса

1. **top_k** (количество чанков)
   - По умолчанию: 5
   - Рекомендации:
     - 3-5 для простых вопросов
     - 7-10 для сложных вопросов, требующих больше контекста
     - Больше чанков = больше контекста, но может быть шум

2. **model** (модель для генерации)
   - По умолчанию: `GigaChat/GigaChat-2-Max`
   - Альтернативы:
     - `Qwen/Qwen3-235B-A22B-Instruct-2507` - лучшее качество, медленнее
     - `Qwen/Qwen3-Next-80B-A3B-Instruct` - баланс скорости и качества

3. **temperature** (креативность)
   - По умолчанию: 0.3
   - Диапазон: 0.0 - 1.0
   - Низкие значения (0.1-0.3): более точные, фактологические ответы
   - Высокие значения (0.7-1.0): более креативные, но менее точные

## Как улучшить качество ответов

### 1. Выбор транскриптов
- Выбирайте только релевантные транскрипты для поиска
- Убедитесь, что транскрипты проиндексированы (проверьте статус индексации)

### 2. Формулировка вопросов
- **Хорошо**: "Какие решения были приняты на встрече?"
- **Плохо**: "Что там было?"

### 3. Настройка параметров
- Для точных фактов: `top_k=3-5`, `temperature=0.1-0.2`
- Для общих вопросов: `top_k=7-10`, `temperature=0.3-0.5`

### 4. Проверка источников
- Всегда проверяйте отображаемые чанки (sources)
- Если чанки нерелевантны, попробуйте переформулировать вопрос

## Дополнительные функции

### Query Expansion
- **Статус**: ✅ Реализовано
- Генерирует 2-3 альтернативные формулировки вопроса
- Создает гипотетический ответ для улучшения поисковых запросов
- Используется только если Multi-hop Reasoning отключен
- **Настройка**: Включить "Enable Query Expansion" в Settings

## Обратная связь

Система собирает обратную связь по качеству ответов:
- **Positive feedback**: Ответ был полезен
- **Negative feedback**: Ответ был неточен или не полезен

Обратная связь помогает улучшить систему в будущем.

## API Endpoints

### Задать вопрос
```
POST /api/rag/ask
{
  "question": "Ваш вопрос",
  "transcript_ids": ["uuid1", "uuid2"],
  "top_k": 5,
  "model": "GigaChat/GigaChat-2-Max",
  "temperature": 0.3
}
```

### Отправить обратную связь
```
POST /api/rag/messages/{message_id}/feedback
{
  "feedback_type": "positive" | "negative",
  "comment": "Опциональный комментарий"
}
```

## Технические детали

### Chunking (Разбиение на фрагменты)
- Размер чанка: 1000 символов
- Перекрытие: 200 символов
- Метод: RecursiveCharacterTextSplitter

### Embeddings
- Модель: `all-MiniLM-L6-v2`
- Размерность: 384
- Fallback: Локальная модель (Evolution Cloud.ru не поддерживает embeddings API)

### Vector Store
- Qdrant collection: `transcript_chunks`
- Distance metric: Cosine
- Indexing: Автоматическая при транскрипции

